<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reproductor Anti-Bloqueo (Multi Canales)</title>
<style>
  :root { color-scheme: dark; }
  body { margin:0; background:#0b0f17; color:#e9eef5; font-family:system-ui,-apple-system,Segoe UI,Roboto; }
  header { display:flex; gap:.75rem; align-items:center; justify-content:space-between; padding:12px 16px; background:#111826; border-bottom:1px solid #233044; }
  h1 { font-size:16px; margin:0; font-weight:700; }
  .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .left, .right { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  select, input[type="text"], textarea, button { background:#1f2b3d; color:#e9eef5; border:1px solid #2b3a52; padding:8px 10px; border-radius:8px; }
  select, input[type="text"] { min-width:260px; }
  textarea { width:100%; min-height:120px; resize:vertical; }
  button { cursor:pointer; font-weight:600; }
  button:hover { background:#2a3a55; }
  .ok { background:#1f3d2b; border-color:#245c3c; } .ok:hover { background:#245c3c; }
  .danger { background:#742a2a; border-color:#9b2c2c; } .danger:hover { background:#9b2c2c; }
  .muted { opacity:.85; }
  .badge { padding:4px 8px; border-radius:999px; background:#1f2b3d; border:1px solid #2b3a52; font-size:12px; }
  .wrap { position:relative; width:100%; height:calc(100vh - 180px); }
  iframe { width:100%; height:100%; border:0; background:#000; }
  .shield {
    position:absolute; inset:0; display:grid; place-items:center;
    background:rgba(9,13,23,.55); backdrop-filter:blur(2px);
  }
  .panel { padding:14px 16px; border-radius:12px; background:#0f1725; border:1px solid #233044; text-align:center; max-width:520px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
  .panel h2 { margin:0 0 8px; font-size:18px; }
  .panel p { margin:6px 0 12px; color:#c8d2e1; }
  .small { font-size:12px; }
  .count { font-variant-numeric: tabular-nums; }
  .tools { padding:10px 16px; background:#0f1624; border-bottom:1px solid #233044; display:flex; gap:1rem; flex-wrap:wrap; }
  .importer { flex:1 1 360px; min-width:320px; }
  .group { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-top:.5rem; }
  footer { padding:8px 16px; opacity:.65; font-size:12px; }
</style>
</head>
<body>
  <header>
    <div class="left">
      <h1>Reproductor con Escudo (Multi Links)</h1>
      <span class="badge">Modo: <strong id="mode">Bloqueado</strong></span>
    </div>
    <div class="right">
      <input id="search" type="text" placeholder="üîé Buscar canal..." />
      <select id="channelSelect" title="Elige un canal"></select>
      <button id="playBtn" class="ok">‚ñ∂ Ver canal</button>
      <button id="btnLock" class="danger">Bloquear</button>
      <button id="btnUnlock" class="ok">Desbloquear</button>
      <span class="small muted">Tips: ‚¨ÜÔ∏è/‚¨áÔ∏è cambia canal ¬∑ Enter desbloquea ¬∑ B bloquea</span>
    </div>
  </header>

  <div class="tools">
    <div class="importer">
      <div class="small muted" style="margin-bottom:6px;">Importar lista r√°pida (formato: <code>Nombre ‚Äî URL</code>, una por l√≠nea)</div>
      <textarea id="bulkInput" placeholder="Caracol TV ‚Äî https://www.tvporinternet2.com/caracol-en-vivo-por-internet.html&#10;RCN ‚Äî https://www.tvporinternet2.com/rcn-en-vivo-por-internet.html"></textarea>
      <div class="group">
        <button id="btnPreview">Previsualizar</button>
        <button id="btnAdd" class="ok">‚ûï Agregar al listado</button>
        <button id="btnClear" class="danger">Limpiar</button>
        <span class="small muted">Se guardan en tu navegador (localStorage).</span>
      </div>
    </div>
    <div>
      <div class="small muted">Ajustes del escudo</div>
      <div class="group">
        <label>Auto-desbloqueo (s): <input id="unlockSeconds" type="number" min="0" step="1" value="8" style="width:80px;"></label>
        <button id="btnApply">Aplicar</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- IFRAME con sandbox sin allow-popups/top-navigation -->
    <iframe id="player"
      referrerpolicy="no-referrer"
      allow="autoplay; fullscreen; picture-in-picture"
      sandbox="allow-scripts allow-same-origin allow-forms allow-presentation">
    </iframe>

    <!-- ESCUDO -->
    <div id="shield" class="shield" aria-hidden="true">
      <div class="panel">
        <h2>Protegiendo la carga del reproductor</h2>
        <p class="muted">Bloqueamos clics/teclas para evitar redirecciones mientras carga.</p>
        <p class="small">Se desbloquea en <span class="count" id="count">8</span>s o usa los botones.</p>
        <div class="row" style="justify-content:center;">
          <button id="unlockNow" class="ok">Desbloquear ahora</button>
          <button id="keepLocked" class="danger">Seguir bloqueado</button>
        </div>
      </div>
    </div>
  </div>

  <footer>Sandbox sin <code>allow-popups</code> para frenar ventanas emergentes. Tus canales y la √∫ltima selecci√≥n se guardan localmente.</footer>

<script>
/** ========= CONFIG ========= **/
let AUTO_UNLOCK_SECONDS = 8;   // Tiempo de protecci√≥n tras cambiar de canal
const STORAGE_LAST = 'antibloqueo:lastChannel';
const STORAGE_LIST = 'antibloqueo:customList';

/** ========= BASE: CATEGOR√çAS Y CANALES =========
 * Puedes mantener esta base y adem√°s importar tus propios links (se suman).
 * Incluyo Caracol (legal) con tu enlace. El resto son placeholders para completar.
 */
const BASE_GROUPS = [
  { label: "Nacionales (CO)", channels: [
    { name: "free premium tv (legal ‚Äì sitio)", url: "https://cuervo-123.github.io/free-premium-tv" },
    { name: "Caracol TV (legal ‚Äì sitio)", url: "https://www.tvporinternet2.com/caracol-en-vivo-por-internet.html" },
    { name: "RCN (agrega URL)", url: "" },
    { name: "Canal 1 (agrega URL)", url: "" },
    { name: "Se√±al Colombia (agrega URL)", url: "" },
    { name: "Canal Institucional (agrega URL)", url: "" },
    { name: "Citytv (agrega URL)", url: "" },
  ]},
  { label: "Regionales (CO)", channels: [
    { name: "Teleantioquia (agrega URL)", url: "" },
    { name: "Telemedell√≠n (agrega URL)", url: "" },
    { name: "Telecaribe (agrega URL)", url: "" },
    { name: "Telepac√≠fico (agrega URL)", url: "" },
    { name: "Canal TRO (agrega URL)", url: "" },
  ]},
  { label: "Noticias", channels: [
    { name: "NTN24 (agrega URL)", url: "" },
    { name: "Noticias Caracol Se√±al (agrega URL)", url: "" },
  ]},
  { label: "Internacionales", channels: [
    { name: "DW Espa√±ol (agrega URL)", url: "" },
    { name: "France 24 ES (agrega URL)", url: "" },
  ]},
];

/** ========= ELEMENTOS ========= **/
const selectEl   = document.getElementById('channelSelect');
const playBtn    = document.getElementById('playBtn');
const iframe     = document.getElementById('player');
const shield     = document.getElementById('shield');
const countEl    = document.getElementById('count');
const btnLock    = document.getElementById('btnLock');
const btnUnlock  = document.getElementById('btnUnlock');
const unlockNow  = document.getElementById('unlockNow');
const keepLocked = document.getElementById('keepLocked');
const modeEl     = document.getElementById('mode');
const searchEl   = document.getElementById('search');
const bulkInput  = document.getElementById('bulkInput');
const btnPreview = document.getElementById('btnPreview');
const btnAdd     = document.getElementById('btnAdd');
const btnClear   = document.getElementById('btnClear');
const unlockSecondsEl = document.getElementById('unlockSeconds');
const btnApply   = document.getElementById('btnApply');

/** ========= ESTADO ========= **/
let locked = true;
let timer = null;
let seconds = AUTO_UNLOCK_SECONDS;
let groups = structuredClone(BASE_GROUPS); // copia base
let customList = []; // lista importada por el usuario

/** ========= HELPERS ========= **/
function setLocked(on) {
  locked = on;
  shield.style.display = on ? 'grid' : 'none';
  modeEl.textContent = on ? 'Bloqueado' : 'Desbloqueado';
  if (on) window.focus();
}

function startCountdown() {
  seconds = AUTO_UNLOCK_SECONDS;
  countEl.textContent = seconds;
  clearInterval(timer);
  timer = setInterval(() => {
    seconds -= 1;
    countEl.textContent = seconds;
    if (seconds <= 0) {
      clearInterval(timer);
      setLocked(false);
    }
  }, 1000);
}

function getAllChannelsFlat() {
  const flat = [];
  for (const g of groups) for (const ch of g.channels) flat.push(ch);
  for (const ch of customList) flat.push(ch);
  return flat;
}

function rebuildSelect(filterText = "") {
  const prev = selectEl.value;
  selectEl.innerHTML = "";
  const f = (s) => s.toLowerCase().includes(filterText.toLowerCase().trim());
  // grupos base
  for (const g of groups) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = g.label;
    for (const ch of g.channels) {
      if (filterText && !(f(ch.name))) continue;
      const opt = document.createElement('option');
      opt.value = JSON.stringify({ type:"base", name: ch.name, url: ch.url });
      opt.textContent = ch.name + (ch.url ? "" : " (falta URL)");
      if (!ch.url) opt.disabled = true;
      optgroup.appendChild(opt);
    }
    if (optgroup.children.length) selectEl.appendChild(optgroup);
  }
  // grupo importados
  const imported = document.createElement('optgroup');
  imported.label = "Importados por ti";
  for (const ch of customList) {
    if (filterText && !(f(ch.name))) continue;
    const opt = document.createElement('option');
    opt.value = JSON.stringify({ type:"custom", name: ch.name, url: ch.url });
    opt.textContent = ch.name;
    imported.appendChild(opt);
  }
  if (imported.children.length) selectEl.appendChild(imported);

  // mantiene selecci√≥n si existe
  for (const o of selectEl.options) {
    if (o.value === prev) { selectEl.value = prev; break; }
  }
}

function loadSelectedChannel(auto = true) {
  if (!selectEl.value) return;
  const info = JSON.parse(selectEl.value);
  const url = info.url;
  if (!url) return;

  // Escudo + cuenta
  setLocked(true);
  startCountdown();

  // Cargar URL
  iframe.src = url;

  // Guardar √∫ltima selecci√≥n
  localStorage.setItem(STORAGE_LAST, url);

  if (auto) window.focus();
}

function changeSelection(delta) {
  const opts = [...selectEl.options];
  if (!opts.length) return;
  let idx = opts.findIndex(o => o.selected);
  idx = idx < 0 ? 0 : idx + delta;
  idx = Math.max(0, Math.min(opts.length - 1, idx));
  opts[idx].selected = true;
  loadSelectedChannel(true);
}

function parseBulk(text) {
  const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  const out = [];
  for (const line of lines) {
    // Formato: Nombre ‚Äî URL  (gui√≥n largo U+2014 o normal -)
    const m = line.split(/‚Äî|-/); // permisivo
    if (m.length < 2) continue;
    const name = m[0].trim();
    const url  = m.slice(1).join('-').trim(); // reensambla si hay m√°s guiones
    if (!name || !/^https?:\/\//i.test(url)) continue;
    out.push({ name, url });
  }
  return out;
}

function saveCustomList() {
  localStorage.setItem(STORAGE_LIST, JSON.stringify(customList));
}

function loadCustomList() {
  try {
    const raw = localStorage.getItem(STORAGE_LIST);
    if (raw) customList = JSON.parse(raw);
  } catch {}
}

/** ========= EVENTOS ========= **/
playBtn.addEventListener('click', () => loadSelectedChannel(true));
selectEl.addEventListener('change', () => loadSelectedChannel(false));
btnLock.addEventListener('click', () => { clearInterval(timer); setLocked(true); startCountdown(); });
btnUnlock.addEventListener('click', () => { clearInterval(timer); setLocked(false); });
unlockNow.addEventListener('click', () => { clearInterval(timer); setLocked(false); });
keepLocked.addEventListener('click', () => { clearInterval(timer); startCountdown(); });

searchEl.addEventListener('input', () => rebuildSelect(searchEl.value));

btnPreview.addEventListener('click', () => {
  const parsed = parseBulk(bulkInput.value);
  if (!parsed.length) { alert("No se reconocieron entradas v√°lidas. Usa: Nombre ‚Äî URL"); return; }
  alert("Detectados " + parsed.length + " canales.\n\n" + parsed.map(x => `‚Ä¢ ${x.name}`).join('\n'));
});

btnAdd.addEventListener('click', () => {
  const parsed = parseBulk(bulkInput.value);
  if (!parsed.length) { alert("No se reconocieron entradas v√°lidas. Usa: Nombre ‚Äî URL"); return; }
  // merge evitando duplicados por nombre
  const names = new Set(customList.map(c => c.name.toLowerCase()));
  for (const p of parsed) {
    if (!names.has(p.name.toLowerCase())) customList.push(p);
  }
  saveCustomList();
  rebuildSelect(searchEl.value);
  bulkInput.value = "";
});

btnClear.addEventListener('click', () => {
  if (!confirm("¬øBorrar la lista importada (no la base)?")) return;
  customList = [];
  saveCustomList();
  rebuildSelect(searchEl.value);
});

btnApply.addEventListener('click', () => {
  const v = Math.max(0, Number(unlockSecondsEl.value || 0) | 0);
  AUTO_UNLOCK_SECONDS = v;
  // si el escudo est√° visible, actualiza contador visible:
  if (locked) { clearInterval(timer); startCountdown(); }
});

// Teclas globales
['keydown','keypress','keyup'].forEach(type => {
  document.addEventListener(type, e => {
    if (type === 'keydown') {
      if (e.key === 'ArrowUp')  { e.preventDefault(); changeSelection(-1); return; }
      if (e.key === 'ArrowDown'){ e.preventDefault(); changeSelection(1); return; }
      if (e.key.toLowerCase?.() === 'b') { e.preventDefault(); setLocked(true); startCountdown(); return; }
      if (e.key === 'Enter') { e.preventDefault(); setLocked(false); return; }
    }
    if (locked) { e.preventDefault(); e.stopPropagation(); return false; }
  }, true);
});

// Observador opcional de cambios de src
const observer = new MutationObserver(() => { /* puedes monitorear iframe.src aqu√≠ si quieres */ });
observer.observe(iframe, { attributes: true, attributeFilter: ['src'] });

/** ========= INICIO ========= **/
loadCustomList();
rebuildSelect("");
// selecciona √∫ltimo canal por URL si existe
const lastUrl = localStorage.getItem(STORAGE_LAST);
if (lastUrl) {
  // busca opci√≥n con esa URL
  const opts = [...selectEl.options];
  const found = opts.find(o => { try { return JSON.parse(o.value).url === lastUrl; } catch { return false; } });
  if (found) found.selected = true;
}
if (selectEl.options.length > 0) {
  loadSelectedChannel(true);
}
</script>
</body>
</html>
